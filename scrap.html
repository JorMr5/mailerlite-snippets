<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Calculadora de Scrap Premium ‚Äî Inyec.pro</title>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">

<style>
:root{
  --bg:#000000;
  --accent:#5cbcae;
  --muted:#8fbfb2;
  --text:#e6f7f2;
  --card-border: rgba(92,188,174,0.18);
}
*{box-sizing:border-box}

/* CAMBIO 1: Quitamos height:100%, overflow hidden y el flex de centrado vertical */
html,body{
    min-height: 100vh; /* Para que el fondo cubra todo */
    margin:0;
    padding: 0; /* El padding lo moveremos al wrap para medir mejor */
    background:var(--bg);
    font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial;
    color:var(--text);
    -webkit-font-smoothing:antialiased;
    overflow: hidden; /* Opcional, pero mejor dejar que el iframe decida */
}

/* subtle grid background */
.bg-grid{position:fixed;inset:0;pointer-events:none;z-index:0;
  background-image:linear-gradient(rgba(255,255,255,0.015) 1px, transparent 1px), linear-gradient(90deg, rgba(255,255,255,0.015) 1px, transparent 1px);
  background-size:44px 44px,44px 44px;opacity:0.06;
}

/* CAMBIO 2: Padding en el contenedor principal para que el script mida bien la altura total */
.wrap{
    width:100%;
    max-width:980px;
    z-index:1;
    margin: 0 auto;
    padding: 26px; /* Padding movido aqu√≠ desde el body */
}

.shell{border-radius:14px;padding:20px;background:linear-gradient(180deg, rgba(255,255,255,0.012), rgba(0,0,0,0.06));border:1px solid rgba(255,255,255,0.02);box-shadow:0 20px 50px rgba(0,0,0,0.7);display:grid;gap:18px}

/* header */
.header{display:flex;justify-content:space-between;align-items:flex-start;gap:12px}
.title{font-weight:800;color:var(--accent);font-size:24px;font-family:"Space Mono",monospace;display:flex;align-items:center;gap:10px}
.title .dash{width:36px;height:2px;background:linear-gradient(90deg, rgba(92,188,174,0.9), rgba(92,188,174,0.3));box-shadow:0 0 14px rgba(92,188,174,0.25)}
.subtitle{color:var(--muted);font-size:13px;margin-top:4px}

/* area */
.area{display:grid;grid-template-columns:1fr 1fr;gap:18px}

/* card base */
.card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.04));border-radius:12px;padding:16px;border:1px solid rgba(255,255,255,0.04);position:relative}
.inputs-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.field{background:linear-gradient(180deg, rgba(255,255,255,0.015), rgba(0,0,0,0.04));border-radius:10px;padding:12px;border:1px solid rgba(255,255,255,0.03)}
.field label{font-size:13px;color:var(--muted);font-weight:700;margin-bottom:8px;display:block}
.field input{background:#020404;color:var(--text);border:1px solid rgba(255,255,255,0.03);padding:14px;border-radius:8px;font-size:18px;transition:box-shadow .18s,transform .12s;width:100%}
.field input:focus{outline:none;box-shadow:0 0 14px rgba(92,188,174,0.25),0 0 4px rgba(92,188,174,0.12) inset;transform:translateY(-1px)}

/* actions */
.actions{display:flex;gap:12px;margin-top:12px}
.btn{background:var(--accent);color:#021916;border:0;padding:12px 14px;border-radius:10px;font-weight:800;cursor:pointer;font-size:16px;box-shadow:0 10px 26px rgba(92,188,174,0.15)}
.btn.ghost{background:transparent;color:var(--muted);border:1px solid rgba(255,255,255,0.05)}

/* email gate */
.email-gate{margin-top:12px;padding:12px;border-radius:10px;border:1px solid rgba(255,255,255,0.03);background:linear-gradient(180deg, rgba(255,255,255,0.015), rgba(0,0,0,0.04))}
.email-row{display:flex;gap:10px;align-items:center; flex-wrap: wrap;} /* CAMBIO 3: wrap permitido */
.email-row input{flex:1;padding:12px;border-radius:8px;border:1px solid rgba(255,255,255,0.03);background:#010202;color:var(--text);font-size:16px; min-width: 180px;}
.consent{display:flex;gap:10px;align-items:flex-start;margin-top:8px;color:var(--muted);font-size:13px}

/* results */
.results-grid{display:grid;grid-template-columns:repeat(1,1fr);gap:14px}
.result{background:linear-gradient(180deg, rgba(10,16,18,0.65), rgba(7,11,12,0.5));border-radius:10px;padding:14px;border:1px solid var(--card-border);position:relative;overflow:hidden;min-height:78px;box-shadow:0 0 18px rgba(92,188,174,0.05)}
.label{font-size:13px;color:var(--muted);font-weight:700}
.value{font-size:26px;font-weight:800;color:var(--text);margin-top:8px;display:inline-block}

/* glow dynamic (applies always, subtle) */
@keyframes glow{0%{box-shadow:0 0 10px rgba(92,188,174,0.05)}50%{box-shadow:0 0 22px rgba(92,188,174,0.18)}100%{box-shadow:0 0 10px rgba(92,188,174,0.05)}}
.result{animation:glow 4s ease-in-out infinite}

/* GLITCH (medium) - used while locked */
.glitch{position:relative;color:var(--text)}
.glitch:before,.glitch:after{content:attr(data-text);position:absolute;left:0;top:0;opacity:0.55}
.glitch:before{color:#7fffe8;transform:translate(2px,-1px);clip-path:polygon(0 2%,100% 3%,100% 20%,0 18%);animation:glitchBefore 1.8s infinite linear alternate-reverse}
.glitch:after{color:#ff61bf;transform:translate(-2px,1px);clip-path:polygon(0 70%,100% 72%,100% 91%,0 89%);animation:glitchAfter 1.8s infinite linear alternate-reverse}
@keyframes glitchBefore{0%{transform:translate(2px,-1px)}50%{transform:translate(-2px,1px)}100%{transform:translate(1px,-2px)}}
@keyframes glitchAfter{0%{transform:translate(-2px,1px)}50%{transform:translate(2px,-1px)}100%{transform:translate(-1px,2px)}}
@keyframes glitchAnim{0%{transform:none}25%{transform:translate(1px,-1px)}50%{transform:translate(-1px,1px)}75%{transform:translate(1px,0)}100%{transform:none}}

/* LOCKED / UNLOCKED visual states applied to #resultsCard */
#resultsCard.results-locked .value{
  filter:blur(6px) grayscale(.25);
  opacity:0.65;
  transition:filter .35s ease,opacity .35s ease,transform .25s;
  transform:translateZ(0);
}
#resultsCard.results-unlocked .value{
  filter:none;
  opacity:1;
  transition:filter .35s ease,opacity .35s ease;
}

/* responsive adjustments */
@media (max-width:900px){.area{grid-template-columns:1fr}.results-grid{grid-template-columns:1fr 1fr}}
@media (max-width:520px){.inputs-grid{grid-template-columns:1fr}.title{font-size:20px}}

/* CAMBIO 4: Reglas espec√≠ficas para pantallas muy peque√±as (m√≥vil iframe) */
@media (max-width: 620px) {
    .results-grid { grid-template-columns: 1fr !important; gap: 12px; }
    .inputs-grid { grid-template-columns: 1fr !important; }
    .area { grid-template-columns: 1fr !important; }
    .card { padding: 14px; }
    .value { font-size: 22px; }
    .label { font-size: 12px; }
    /* Apilar bot√≥n de desbloqueo en m√≥vil */
    .email-row { display: block; }
    .email-row input { width: 100%; margin-bottom: 10px; }
    .email-row button { width: 100%; }
    .wrap { padding: 14px; } /* Reducir padding en m√≥vil para ganar espacio */
}
</style>
</head>
<body>
<div class="bg-grid" aria-hidden="true"></div>

<div class="wrap">
  <div class="shell">

    <div class="header">
      <div>
        <div class="title"><span class="dash"></span> SCRAP CALC</div>
        <div class="subtitle">Calcula el coste real del scrap</div>
      </div>
      <div style="font-size:12px;color:var(--muted);font-weight:700;align-self:center">inyec.pro</div>
    </div>

    <div class="area">

      <!-- inputs card -->
      <div class="card" id="inputsCard">
        <div style="font-weight:800;font-size:15px;color:var(--accent);margin-bottom:10px">Entradas</div>

        <div class="inputs-grid" role="region" aria-label="Entradas">
          <div class="field">
            <label for="pieces">Piezas / hora</label>
            <input id="pieces" type="number" inputmode="numeric" min="0" placeholder="120" />
          </div>

          <div class="field">
            <label for="weight">Peso pieza (g)</label>
            <input id="weight" type="number" inputmode="numeric" min="0" placeholder="34" />
          </div>

          <div class="field">
            <label for="scrap"> % Scrap</label>
            <input id="scrap" type="number" inputmode="numeric" min="0" max="100" step="0.01" placeholder="2.5" />
          </div>

          <div class="field">
            <label for="price">Precio ‚Ç¨/kg (granza)</label>
            <input id="price" type="number" inputmode="numeric" min="0" step="0.01" placeholder="2.50" />
          </div>
        </div>

        <div class="actions" role="group" aria-label="Acciones">
          <button class="btn" id="calcBtn">Calcular</button>
          <button class="btn ghost" id="resetBtn">Reset</button>
        </div>

        <div class="email-gate" aria-hidden="false">
          <div style="font-weight:700;color:var(--muted);margin-bottom:6px">üîí Desbloquea resultados</div>
          <div class="email-row">
            <input id="email" type="email" placeholder="tu@empresa.com" />
            <button class="btn" id="unlockBtn">Desbloquear</button>
          </div>
          <div class="consent">
            <input id="consent" type="checkbox" />
            <div>Acepto que mi correo se incluya en la lista de correo de inyec.pro</div>
          </div>
        </div>
      </div>

      <!-- results card with explicit id -->
      <div class="card" id="resultsCard" aria-labelledby="resultsTitle">
        <div id="resultsTitle" style="font-weight:800;font-size:15px;color:var(--accent);margin-bottom:10px">Resultados</div>

        <div class="results-grid" role="region" aria-label="Resultados">
          <div class="result" id="resH"><div class="label">‚Ç¨/Hora</div><div class="value glitch" id="vHour" data-text="‚Äî">‚Äî</div></div>
          <div class="result" id="resD"><div class="label">‚Ç¨/D√≠a (24h)</div><div class="value glitch" id="vDay" data-text="‚Äî">‚Äî</div></div>
          <div class="result" id="resM"><div class="label">‚Ç¨/Mes (30d)</div><div class="value glitch" id="vMonth" data-text="‚Äî">‚Äî</div></div>
          <div class="result" id="resY"><div class="label">‚Ç¨/A√±o</div><div class="value glitch" id="vYear" data-text="‚Äî">‚Äî</div></div>
        </div>

    </div>
  </div>
</div>

<script>
/* webhook */
const webhookURL = "https://hook.eu2.make.com/axx0jrw2x1cul6e8shm7hs6ucfg7l6of";

/* DOM */
const pieces = document.getElementById("pieces");
const weight = document.getElementById("weight");
const scrap = document.getElementById("scrap");
const price = document.getElementById("price");

const calcBtn = document.getElementById("calcBtn");
const resetBtn = document.getElementById("resetBtn");
const unlockBtn = document.getElementById("unlockBtn");
const emailI = document.getElementById("email");
const consent = document.getElementById("consent");
const downloadBtn = document.getElementById("downloadBtn");

const vHour = document.getElementById("vHour");
const vDay = document.getElementById("vDay");
const vMonth = document.getElementById("vMonth");
const vYear = document.getElementById("vYear");

const resultsCard = document.getElementById("resultsCard");

let computed = null;

/* format */
function fmt(v){ return Number(v).toLocaleString('es-ES',{style:'currency',currency:'EUR',maximumFractionDigits:2}); }

/* validate */
function validate(){
  const p = Number(pieces.value), w = Number(weight.value), s = Number(scrap.value), pr = Number(price.value);
  if(!isFinite(p) || p<=0) return {ok:false,msg:"Piezas / hora debe ser > 0"};
  if(!isFinite(w) || w<=0) return {ok:false,msg:"Peso pieza (g) debe ser > 0"};
  if(!isFinite(s) || s<0 || s>100) return {ok:false,msg:"% Scrap debe estar entre 0 y 100"};
  if(!isFinite(pr) || pr<=0) return {ok:false,msg:"Precio ‚Ç¨/kg debe ser > 0"};
  return {ok:true,p,w,s,pr};
}

/* compute */
function computeValues(){
  const v = validate();
  if(!v.ok){ alert(v.msg); return null; }
  const piecesPerHour = v.p;
  const weightKg = v.w / 1000;
  const scrapFrac = v.s / 100;
  const priceKg = v.pr;

  const lostKgHour = piecesPerHour * scrapFrac * weightKg;
  const costHour = lostKgHour * priceKg;
  const costDay = costHour * 24;
  const costMonth = costDay * 30;
  const costYear = costDay * 365;

  return {costHour, costDay, costMonth, costYear};
}

/* show locked values (blur + glitch) */
function showLocked(vals){
  if(!vals) return;
  computed = vals;
  // add locked state to results card
  resultsCard.classList.remove("results-unlocked");
  resultsCard.classList.add("results-locked");

  // set data-text and visible text (glitch appears via CSS)
  const set = (el,val) => { el.setAttribute("data-text", fmt(val)); el.textContent = fmt(val); el.classList.add("glitch"); };
  set(vHour, vals.costHour);
  set(vDay, vals.costDay);
  set(vMonth, vals.costMonth);
  set(vYear, vals.costYear);
}

/* unlock and animate counters */
function unlockValues(){
  if(!computed) return;
  // remove locked class, add unlocked
  resultsCard.classList.remove("results-locked");
  resultsCard.classList.add("results-unlocked");

  const animate = (el, end, duration=900) => {
    // remove glitch so text becomes clean
    el.classList.remove("glitch");
    let start = 0;
    const steps = Math.max(12, Math.round(duration/20));
    let step = 0;
    const timer = setInterval(()=>{
      step++;
      const t = step/steps;
      const eased = 1 - Math.pow(1 - t, 3);
      const v = start + (end - start) * eased;
      el.textContent = fmt(v);
      if(step >= steps){ clearInterval(timer); el.textContent = fmt(end); }
    },20);
  };

  animate(vHour, computed.costHour, 900);
  animate(vDay, computed.costDay, 1100);
  animate(vMonth, computed.costMonth, 1300);
  animate(vYear, computed.costYear, 1500);
}

/* send email to webhook (fire-and-forget) */
async function sendWebhook(email){
  try{
    await fetch(webhookURL, {
      method: "POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify({ email, source: "calculadora_scrap" })
    });
    return true;
  }catch(e){
    console.warn("Webhook send failed", e);
    return false;
  }
}

/* events */
calcBtn.addEventListener('click', () => {
  const vals = computeValues();
  if(!vals) return;
  showLocked(vals);
  // small visual pulse on result cards
  document.querySelectorAll('#resultsCard .result').forEach(c=>{ c.style.transform='translateY(-6px)'; c.style.transition='transform .18s'; setTimeout(()=>c.style.transform='',180); });
});

resetBtn.addEventListener('click', () => {
  pieces.value = weight.value = scrap.value = price.value = "";
  emailI.value = "";
  consent.checked = false;
  computed = null;
  // restore placeholders
  [vHour,vDay,vMonth,vYear].forEach(el=>{
    el.textContent = "‚Äî"; el.setAttribute("data-text","‚Äî"); el.classList.remove("glitch");
  });
  resultsCard.classList.remove("results-locked"); resultsCard.classList.remove("results-unlocked");
});

unlockBtn.addEventListener('click', async () => {
  if(!computed){ alert("Calcula primero"); return; }
  const mail = emailI.value.trim();
  if(!mail || mail.indexOf("@")<0){ alert("Email inv√°lido"); return; }
  if(!consent.checked){ alert("Debes aceptar el consentimiento"); return; }

  unlockBtn.disabled = true; unlockBtn.textContent = "Enviando...";
  await sendWebhook(mail); // don't block UX on failure
  setTimeout(()=>{ unlockBtn.disabled=false; unlockBtn.textContent="Desbloquear"; },700);

  // finally unlock and animate counters
  unlockValues();
});


/* keyboard accessibility */
document.addEventListener('keydown', (e)=>{
  if(e.key === "Enter"){
    const active = document.activeElement;
    if([pieces,weight,scrap,price].includes(active)) calcBtn.click();
    if(active === emailI) unlockBtn.click();
  }
});
</script>

<script>
function sendHeight() {
    // Medimos el wrapper principal que tiene el padding y el contenido
    const wrap = document.querySelector('.wrap');
    if(wrap) {
        // Altura del contenido + un peque√±o buffer por seguridad
        const height = wrap.offsetHeight; 
        parent.postMessage(
            { type: "SCRAP_CALC_RESIZE", height: height },
            "*"
        );
    }
}

// Enviar altura al cargar
window.addEventListener("load", sendHeight);

// Detectar cambios en el tama√±o del wrapper espec√≠ficamente
const resizeObserver = new ResizeObserver(sendHeight);
const wrapEl = document.querySelector('.wrap');
if(wrapEl) resizeObserver.observe(wrapEl);

// Fallback extra por si las im√°genes o fuentes cargan tarde
setTimeout(sendHeight, 1000);
window.addEventListener('resize', sendHeight);
</script>

</body>
</html>
